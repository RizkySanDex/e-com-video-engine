<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Com Video Engine v2.4 - Stable</title>
    <!-- (CSS dan HTML sama persis dengan v2.2) -->
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.2/dist/ffmpeg.min.js"></script>
    <style>
        :root { --bg-color: #1e1e1e; --text-color: #e0e0e0; --panel-bg: #2a2a2a; --secondary-bg: #3c3c3c; --border-color: #555; --primary-accent: #4a90e2; --success-color: #28a745; } body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg-color); color: var(--text-color); display: flex; flex-direction: column; align-items: center; margin: 0; padding: 20px; } .main-container { display: flex; flex-wrap: wrap; gap: 20px; width: 100%; max-width: 1200px; } .input-panel { flex: 1; min-width: 450px; background-color: var(--panel-bg); border-radius: 10px; padding: 20px; } .preview-panel { flex: 1; min-width: 400px; background-color: var(--panel-bg); border-radius: 10px; padding: 20px; text-align: center; } h1, h2, h3 { color: var(--primary-accent); } .scene-group { margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); } label { display: block; margin-bottom: 5px; font-weight: bold; } input[type="text"], select { width: 100%; padding: 10px; box-sizing: border-box; background-color: var(--secondary-bg); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 5px; } .media-buttons { display: flex; gap: 10px; margin-bottom: 10px; } .file-label { flex: 1; display: block; padding: 10px; background-color: var(--secondary-bg); border: 1px dashed var(--border-color); color: var(--text-color); border-radius: 5px; text-align: center; cursor: pointer; } .file-label.uploaded { background-color: var(--success-color); color: white; border-style: solid; font-weight: bold; } input[type="file"] { display: none; } #generate-button { width: 100%; padding: 15px; font-size: 1.2em; font-weight: bold; background-color: var(--success-color); color: white; border: none; border-radius: 5px; cursor: pointer; } #output-video { max-width: 100%; border-radius: 8px; margin-top: 15px; background-color: #000; } #progress-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); color: white; display: none; justify-content: center; align-items: center; flex-direction: column; z-index: 1000; text-align: center; } #progress-text { font-size: 1.5em; margin-bottom: 20px; } .loader { border: 8px solid #f3f3f3; border-radius: 50%; border-top: 8px solid var(--primary-accent); width: 60px; height: 60px; animation: spin 2s linear infinite; margin-bottom: 20px; } @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } } #progress-bar-container { width: 80%; max-width: 500px; height: 20px; background-color: #555; border-radius: 10px; overflow: hidden; display: none; } #progress-bar-fill { width: 0%; height: 100%; background-color: var(--primary-accent); border-radius: 10px; transition: width 0.2s ease-out; } #progress-percentage { margin-top: 10px; font-size: 1.2em; font-weight: bold; display: none; }
    </style>
</head>
<body>
    <!-- (HTML sama persis) -->
    <div id="progress-overlay">...</div>
    <h1>E-Com Video Engine v2.4</h1>
    <div class="main-container">...</div>

    <script>
        const { createFFmpeg, fetchFile } = FFmpeg;
        const ffmpeg = createFFmpeg({
            log: true,
            progress: (p) => {
                const percentage = Math.round(p.ratio * 100);
                document.getElementById('progress-bar-fill').style.width = `${percentage}%`;
                document.getElementById('progress-percentage').textContent = `${percentage}%`;
            },
            // Gunakan link corePath yang sudah benar
            corePath: "https://unpkg.com/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js",
        });

        // ... (Kode setup awal dan event listener sama persis)

        async function generateVideo() {
            // ... (Kode validasi dan persiapan file sama)
            const progressOverlay = document.getElementById('progress-overlay');
            const progressText = document.getElementById('progress-text');
            const loadingSpinner = document.getElementById('loading-spinner');
            const progressBarContainer = document.getElementById('progress-bar-container');
            const progressPercentage = document.getElementById('progress-percentage');
            // ... (Kode untuk menampilkan overlay dan loading)
            
            // --- Perintah FFmpeg yang Disederhanakan dan Stabil (Kembali ke Logika v2.2) ---
            const command = [];
            const filterComplex = [];
            const concatInputs = [];

            scenes.forEach((scene, i) => {
                // Tambahkan argumen input. Untuk gambar, '-loop 1' sangat penting.
                if (scene.isImage) {
                    command.push('-loop', '1');
                }
                command.push('-i', scene.mediaFile.name);

                let inputStream = `[${i}:v]`;
                let processedStream = `[v${i}_processed]`;

                // Buat filter chain untuk setiap input
                let filterChain = "";
                if (scene.isImage) {
                    // Untuk gambar: loop selama durasi, beri efek Ken Burns, dan atur ukuran
                    filterChain = `${inputStream}tpad=stop_duration=${scene.duration},zoompan=z='min(zoom+0.0015,1.5)':d=${scene.duration*25}:s=720x1280,setsar=1`;
                } else {
                    // Untuk video/gif: cukup atur ukuran
                    filterChain = `${inputStream}scale=720:1280,setsar=1`;
                }

                // Tambahkan teks ke filter chain
                const text = texts[scene.id];
                const fontSize = scene.id === 'cta' ? 70 : 60;
                const fontColor = scene.id === 'product' ? 'yellow' : 'white';
                const boxColor = scene.id === 'cta' ? 'red@0.8' : 'black@0.5';
                const yPos = scene.id === 'product' ? 'h*0.3' : 'h*0.7';
                filterChain += `,drawtext=text='${text}':fontsize=${fontSize}:fontcolor=${fontColor}:x=(w-text_w)/2:y=${yPos}:box=1:boxcolor=${boxColor}:boxborderw=10`;
                
                filterComplex.push(filterChain + processedStream);
                concatInputs.push(processedStream);
            });

            // Tambahkan input musik
            command.push('-i', 'music.mp3');
            const audioInputIndex = scenes.length;

            // Gabungkan semua video stream yang sudah diproses
            filterComplex.push(`${concatInputs.join('')}concat=n=${scenes.length}:v=1:a=0[v_out]`);
            // Ambil musik dan atur volumenya
            filterComplex.push(`[${audioInputIndex}:a]volume=0.4[a_out]`);

            command.push('-filter_complex', filterComplex.join(';'));
            command.push('-map', '[v_out]', '-map', '[a_out]');
            const totalDuration = scenes.reduce((sum, s) => sum + s.duration, 0);
            command.push('-t', totalDuration.toString());
            command.push('-c:v', 'libx264', '-preset', 'ultrafast', '-c:a', 'aac', '-pix_fmt', 'yuv420p', 'output.mp4');

            console.log("Running FFmpeg command:", command.join(' '));
            await ffmpeg.run(...command);
            
            // ... (sisa kode untuk menampilkan hasil sama persis)
            progressText.textContent = "Selesai! Menyiapkan Hasil...";
            const data = ffmpeg.FS('readFile', 'output.mp4');
            const videoUrl = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));
            document.getElementById('output-video').src = videoUrl;
            progressOverlay.style.display = 'none';
            const a = document.createElement('a'); a.href = videoUrl; a.download = 'video_result_stable.mp4'; document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }

        // ... (Semua kode helper dan event listener lengkap dari v2.2 ada di sini)
    </script>
</body>
</html>