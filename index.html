<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>E-Com Video Engine v3 (Stable COEP)</title>
  <!-- FFmpeg WASM -->
  <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.2/dist/ffmpeg.min.js"></script>
  <style>
    :root{
      --bg:#111;--fg:#eaeaea;--card:#1b1b1b;--muted:#2b2b2b;
      --accent:#4a90e2;--ok:#18a058;--warn:#f0ad4e;--err:#e74c3c;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:1200px;margin:auto;padding:18px;display:grid;gap:18px;grid-template-columns:1.1fr .9fr}
    @media(max-width:960px){.wrap{grid-template-columns:1fr}}
    h1,h2,h3{color:var(--accent);margin:.2rem 0 .8rem}
    .card{background:var(--card);border:1px solid #2a2a2a;border-radius:12px;padding:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .file-label{flex:1;padding:10px;border:1px dashed #444;border-radius:8px;text-align:center;background:var(--muted);cursor:pointer}
    .file-label.uploaded{background:var(--ok);color:#fff;border-style:solid;font-weight:600}
    input[type=file]{display:none}
    input[type=text],select{width:100%;padding:10px;border:1px solid #444;border-radius:8px;background:#131313;color:var(--fg)}
    .btn{width:100%;padding:14px;border:0;border-radius:10px;background:var(--ok);color:#fff;font-size:1.05rem;font-weight:700;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    video{width:100%;border-radius:10px;background:#000}
    .hint{opacity:.8;font-size:.9rem}
    .progress-overlay{
      position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center;flex-direction:column;z-index:9999;color:#fff;text-align:center;padding:20px
    }
    .bar{width:min(520px,86vw);height:18px;background:#3a3a3a;border-radius:12px;overflow:hidden;margin-top:12px}
    .fill{height:100%;width:0%;background:var(--accent);transition:width .2s ease}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:.9rem;opacity:.9}
    .pill{display:inline-block;padding:.2rem .55rem;border-radius:999px;background:#222;border:1px solid #333;margin:2px 0}
  </style>
</head>
<body>
  <div class="progress-overlay" id="overlay">
    <h2 id="ov-text">Mempersiapkanâ€¦</h2>
    <div class="bar"><div class="fill" id="ov-fill"></div></div>
    <div class="mono" id="ov-per">0%</div>
    <div class="mono" id="ov-note" style="margin-top:10px;opacity:.8"></div>
  </div>

  <div class="wrap">
    <div class="card">
      <h1>E-Com Video Engine v3</h1>
      <p class="hint">Susun 3 adegan (Hook â†’ Produk â†’ CTA). Bisa pakai video/GIF <em>atau</em> gambar. Tambahkan teks overlay (opsional). Musik & font di-upload lokal agar aman untuk mode COEP.</p>

      <!-- SCENE 1 -->
      <div class="card" style="margin-top:12px">
        <h3>Adegan 1: Hook (3 detik)</h3>
        <div class="row">
          <label class="file-label" id="hook-v-label" for="hook-v">Pilih Video/GIF</label>
          <input id="hook-v" type="file" accept="video/*,image/gif">
          <label class="file-label" id="hook-i-label" for="hook-i">Pilih Gambar</label>
          <input id="hook-i" type="file" accept="image/png,image/jpeg">
        </div>
        <label>Teks Hook (opsional)</label>
        <input id="hook-text" type="text" placeholder="Contoh: Botol minum gampang bocor?">
      </div>

      <!-- SCENE 2 -->
      <div class="card">
        <h3>Adegan 2: Produk (5 detik)</h3>
        <div class="row">
          <label class="file-label" id="prod-v-label" for="prod-v">Pilih Video/GIF</label>
          <input id="prod-v" type="file" accept="video/*,image/gif">
          <label class="file-label" id="prod-i-label" for="prod-i">Pilih Gambar</label>
          <input id="prod-i" type="file" accept="image/png,image/jpeg">
        </div>
        <label>Teks Solusi (opsional)</label>
        <input id="prod-text" type="text" placeholder="Contoh: Pakai botol anti tumpah ini!">
      </div>

      <!-- SCENE 3 -->
      <div class="card">
        <h3>Adegan 3: CTA (3 detik)</h3>
        <div class="row">
          <label class="file-label" id="cta-v-label" for="cta-v">Pilih Video/GIF</label>
          <input id="cta-v" type="file" accept="video/*,image/gif">
          <label class="file-label" id="cta-i-label" for="cta-i">Pilih Gambar</label>
          <input id="cta-i" type="file" accept="image/png,image/jpeg">
        </div>
        <label>Teks CTA (opsional)</label>
        <input id="cta-text" type="text" placeholder="Contoh: Cek Keranjang Kuning!">
      </div>

      <!-- GLOBAL: FONT & MUSIC -->
      <div class="card">
        <h3>Font & Musik (opsional tapi direkomendasikan)</h3>
        <div class="row">
          <label class="file-label" id="font-label" for="font-file">Upload Font TTF/OTF untuk teks</label>
          <input id="font-file" type="file" accept=".ttf,.otf">
        </div>
        <div class="row">
          <label class="file-label" id="music-label" for="music-file">Upload Musik (MP3/M4A/WAV/OGG)</label>
          <input id="music-file" type="file" accept="audio/*">
        </div>
        <div class="hint">Jika tidak upload musik, sistem akan membuat audio hening (silent) sepanjang durasi.</div>
      </div>

      <button class="btn" id="generate">ðŸš€ Generate & Export Video</button>
      <div class="hint" style="margin-top:10px">
        Tip: untuk teks overlay, upload font (contoh: <span class="pill">Inter-Regular.ttf</span>). Tanpa font, <code>drawtext</code> bisa gagal di WebAssembly.
      </div>
    </div>

    <div class="card">
      <h2>Preview & Hasil</h2>
      <video id="out" controls></video>
      <div class="mono" style="margin-top:12px">
        Log singkat: cek DevTools Console untuk detail error FFmpeg jika render gagal.
      </div>
    </div>
  </div>

  <script>
    const { createFFmpeg, fetchFile } = FFmpeg;

    // UI refs
    const overlay = document.getElementById('overlay');
    const ovText = document.getElementById('ov-text');
    const ovFill = document.getElementById('ov-fill');
    const ovPer  = document.getElementById('ov-per');
    const ovNote = document.getElementById('ov-note');
    const outVideo = document.getElementById('out');
    const btn = document.getElementById('generate');

    // Scene state
    const scenes = [
      { id:'hook',   dur:3, input:null, isImage:false, textEl: 'hook-text',  v:'hook-v',  i:'hook-i',  vLabel:'hook-v-label',  iLabel:'hook-i-label' },
      { id:'product',dur:5, input:null, isImage:false, textEl: 'prod-text',  v:'prod-v',  i:'prod-i',  vLabel:'prod-v-label',  iLabel:'prod-i-label' },
      { id:'cta',    dur:3, input:null, isImage:false, textEl: 'cta-text',   v:'cta-v',   i:'cta-i',   vLabel:'cta-v-label',   iLabel:'cta-i-label' }
    ];

    // File selectors
    function wireFileLabel(fileId, labelId, markAs){
      const input = document.getElementById(fileId);
      const label = document.getElementById(labelId);
      input.addEventListener('change', e=>{
        if(!e.target.files[0]) return;
        label.classList.add('uploaded');
        label.textContent = e.target.files[0].name;
        markAs(e.target.files[0]);
      });
    }

    // Attach listeners per scene
    scenes.forEach((s, idx)=>{
      wireFileLabel(s.v, s.vLabel, (f)=>{ scenes[idx].input=f; scenes[idx].isImage = f.type.startsWith('image/'); });
      wireFileLabel(s.i, s.iLabel, (f)=>{ scenes[idx].input=f; scenes[idx].isImage = true; });
    });

    // Font & music inputs
    const fontInput  = document.getElementById('font-file');
    const musicInput = document.getElementById('music-file');
    wireFileLabel('font-file','font-label', ()=>{});
    wireFileLabel('music-file','music-label', ()=>{});

    // FFmpeg instance
    const ffmpeg = createFFmpeg({
      log: true,
      progress: ({ratio})=>{
        const p = Math.max(0, Math.min(100, Math.round(ratio*100)));
        ovFill.style.width = p + '%';
        ovPer.textContent = p + '%';
        ovText.textContent = 'Rendering Videoâ€¦ ' + p + '%';
      },
      corePath: "https://unpkg.com/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js",
    });

    function sanitizeText(s){
      // Escape chars that break drawtext
      return (s||'').replace(/[:'\\\[\]\n\r]/g, m=>'\\'+m);
    }

    function extOf(name, fallback){
      const dot = (name||'').lastIndexOf('.');
      return dot>0 ? name.slice(dot+1).toLowerCase() : (fallback||'dat');
    }

    btn.addEventListener('click', generate);

    async function generate(){
      try{
        // Basic validation
        if (scenes.some(s=>!s.input)) {
          alert('Harap lengkapi media untuk semua adegan (video/GIF atau gambar).');
          return;
        }

        overlay.style.display='flex';
        ovText.textContent = 'Memuat mesin renderâ€¦';
        ovPer.textContent = '0%';
        ovFill.style.width = '0%';
        ovNote.textContent = '';

        if(!ffmpeg.isLoaded()){
          await ffmpeg.load();
        }

        // Write inputs to FS with fixed safe names
        for (let i=0;i<scenes.length;i++){
          const s = scenes[i];
          const safeName = `scene${i}.${s.isImage ? extOf(s.input.name,'png') : extOf(s.input.name,'mp4')}`;
          s.fsName = safeName;
          ffmpeg.FS('writeFile', safeName, await fetchFile(s.input));
        }

        // Write font if provided
        let fontPath = null;
        if (fontInput.files && fontInput.files[0]) {
          const fext = extOf(fontInput.files[0].name,'ttf');
          fontPath = `font.${fext}`;
          ffmpeg.FS('writeFile', fontPath, await fetchFile(fontInput.files[0]));
        }

        // Music: write if provided, else we'll synthesize silence
        let hasMusic = false;
        if (musicInput.files && musicInput.files[0]) {
          ffmpeg.FS('writeFile', 'music.input', await fetchFile(musicInput.files[0]));
          hasMusic = true;
        }

        // Prepare filter graph
        const filterParts = [];
        const concatVidRefs = [];

        for (let i=0;i<scenes.length;i++){
          const s = scenes[i];
          const inV = `[${i}:v]`;
          const outV = `[v${i}]`;

          // For images: loop + Ken Burns zoom; For video: scale & trim
          if (s.isImage){
            filterParts.push(
              `${inV}tpad=stop_duration=${s.dur},` +
              `zoompan=z='min(zoom+0.0018,1.5)':d=${s.dur*30}:s=720x1280:fps=30,setsar=1${outV}`
            );
          }else{
            filterParts.push(
              `${inV}scale=720:1280:force_original_aspect_ratio=decrease,`+
              `pad=720:1280:(ow-iw)/2:(oh-ih)/2:black,`+
              `trim=duration=${s.dur},setsar=1,fps=30${outV}`
            );
          }

          // Draw text if any AND font available
          const rawText = document.getElementById(s.textEl).value.trim();
          if (rawText && fontPath){
            const t = sanitizeText(rawText);
            const fontSize = (s.id==='cta')? 60 : 52;
            const fontColor = (s.id==='product')? 'yellow' : 'white';
            const boxColor  = (s.id==='cta')? 'red@0.8'  : 'black@0.55';
            const yPos      = (s.id==='product')? 'h*0.28' : 'h*0.78';

            // Apply drawtext to previous outV -> new labeled stream
            const afterTxt = `[v${i}t]`;
            filterParts.push(
              `${outV}drawtext=fontfile=${fontPath}:text='${t}':`+
              `fontsize=${fontSize}:fontcolor=${fontColor}:`+
              `x=(w-text_w)/2:y=${yPos}:box=1:boxcolor=${boxColor}:boxborderw=12${afterTxt}`
            );
            concatVidRefs.push(afterTxt);
          } else {
            // If no text or no font: use the processed clip as is
            concatVidRefs.push(outV);
          }
        }

        // Audio chain
        // If music provided: [A] -> apad -> atrim=total
        // else: synthesize silence using anullsrc
        const totalDur = scenes.reduce((a,b)=>a+b.dur,0);
        if (hasMusic){
          filterParts.push(`[${scenes.length}:a]apad=pad_dur=${totalDur},atrim=0:${totalDur}[aout]`);
        }else{
          // Use lavfi to generate silent audio (mono 48k)
          // Note: needs -f lavfi & -t with separate input; we'll add as extra input
          // Create a silent track via filter_complex
          filterParts.push(`anullsrc=r=48000:cl=stereo,atrim=0:${totalDur}[aout]`);
        }

        // Concat videos
        filterParts.push(`${concatVidRefs.join('')}concat=n=${scenes.length}:v=1:a=0[vout]`);

        // Build command
        const cmd = [];

        // Push video/image inputs
        for (let i=0;i<scenes.length;i++){
          const s = scenes[i];
          if (s.isImage) cmd.push('-loop','1');
          cmd.push('-i', s.fsName);
        }

        // If music: add as normal input, else we'll rely on generated aout
        if (hasMusic) {
          cmd.push('-i','music.input');
        }

        // If no music, we still can create [aout] in filter_complex from anullsrc (no extra -i)
        // Compose filter
        const fc = filterParts.join(';');

        // Because we used anullsrc when no music, we must prefix that with -f lavfi as a separate input
        // But we already embedded it inside filter_complex (without extra input) â€” valid in latest ffmpeg.
        // So just run one filter_complex.

        cmd.push('-filter_complex', fc);
        cmd.push('-map','[vout]','-map','[aout]');

        // Encoding & container
        cmd.push('-t', String(totalDur));
        cmd.push('-c:v','libx264','-preset','ultrafast','-pix_fmt','yuv420p');
        cmd.push('-c:a','aac','-b:a','128k');
        cmd.push('-movflags','+faststart');
        cmd.push('-y','output.mp4');

        // Notes for overlay
        ovText.textContent = 'Memproses Videoâ€¦';
        ovNote.textContent = 'Jika macet di 0%, tunggu sampai core FFmpeg selesai diunduh.';

        // Run
        console.log('Running FFmpeg:', cmd.join(' '));
        await ffmpeg.run(...cmd);

        // Check FS
        const files = ffmpeg.FS('readdir','/');
        console.log('FS root:', files);

        // Read output
        const data = ffmpeg.FS('readFile','output.mp4');
        const url = URL.createObjectURL(new Blob([data.buffer], { type:'video/mp4' }));
        outVideo.src = url;

        overlay.style.display='none';

        // Auto-download
        const a = document.createElement('a');
        a.href = url; a.download = 'ecom-video.mp4';
        document.body.appendChild(a); a.click(); a.remove();

      }catch(err){
        console.error('FFmpeg error:', err);
        ovText.textContent = 'Gagal Render';
        ovNote.textContent = 'Cek Console (DevTools) untuk detail error. Umumnya: font tidak diupload atau filter salah.';
        ovPer.textContent = 'â€”';
        ovFill.style.width = '0%';
        setTimeout(()=>{ overlay.style.display='none'; }, 2500);
      }
    }
  </script>
</body>
</html>
