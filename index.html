<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Com Video Engine v2.2 - Loading Fix</title>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.2/dist/ffmpeg.min.js"></script>
    <style>
        /* (CSS dari v2.1, dengan tambahan untuk spinner) */
        :root { --bg-color: #1e1e1e; --text-color: #e0e0e0; --panel-bg: #2a2a2a; --secondary-bg: #3c3c3c; --border-color: #555; --primary-accent: #4a90e2; --success-color: #28a745; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg-color); color: var(--text-color); display: flex; flex-direction: column; align-items: center; margin: 0; padding: 20px; }
        .main-container { display: flex; flex-wrap: wrap; gap: 20px; width: 100%; max-width: 1200px; }
        .input-panel { flex: 1; min-width: 450px; background-color: var(--panel-bg); border-radius: 10px; padding: 20px; }
        .preview-panel { flex: 1; min-width: 400px; background-color: var(--panel-bg); border-radius: 10px; padding: 20px; text-align: center; }
        h1, h2, h3 { color: var(--primary-accent); }
        .scene-group { margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], select { width: 100%; padding: 10px; box-sizing: border-box; background-color: var(--secondary-bg); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 5px; }
        .media-buttons { display: flex; gap: 10px; margin-bottom: 10px; }
        .file-label { flex: 1; display: block; padding: 10px; background-color: var(--secondary-bg); border: 1px dashed var(--border-color); color: var(--text-color); border-radius: 5px; text-align: center; cursor: pointer; }
        .file-label.uploaded { background-color: var(--success-color); color: white; border-style: solid; font-weight: bold; }
        input[type="file"] { display: none; }
        #generate-button { width: 100%; padding: 15px; font-size: 1.2em; font-weight: bold; background-color: var(--success-color); color: white; border: none; border-radius: 5px; cursor: pointer; }
        #output-video { max-width: 100%; border-radius: 8px; margin-top: 15px; background-color: #000; }
        
        #progress-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); color: white; display: none; justify-content: center; align-items: center; flex-direction: column; z-index: 1000; text-align: center; }
        #progress-text { font-size: 1.5em; margin-bottom: 20px; }
        
        /* --- UI BARU UNTUK SPINNER & PROGRESS BAR --- */
        .loader { border: 8px solid #f3f3f3; border-radius: 50%; border-top: 8px solid var(--primary-accent); width: 60px; height: 60px; animation: spin 2s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #progress-bar-container { width: 80%; max-width: 500px; height: 20px; background-color: #555; border-radius: 10px; overflow: hidden; display: none; } /* Awalnya disembunyikan */
        #progress-bar-fill { width: 0%; height: 100%; background-color: var(--primary-accent); border-radius: 10px; transition: width 0.2s ease-out; }
        #progress-percentage { margin-top: 10px; font-size: 1.2em; font-weight: bold; display: none; } /* Awalnya disembunyikan */

    </style>
</head>
<body>
    <div id="progress-overlay">
        <div class="loader" id="loading-spinner"></div>
        <h2 id="progress-text">Mempersiapkan...</h2>
        <div id="progress-bar-container">
            <div id="progress-bar-fill"></div>
        </div>
        <p id="progress-percentage">0%</p>
    </div>

    <h1>E-Com Video Engine v2.2</h1>
    <p style="margin-bottom: 20px;">Kombinasikan Video, GIF, dan Gambar untuk membuat video jualanmu!</p>

    <!-- (Struktur HTML lainnya sama persis dengan v2.0) -->
    <div class="main-container">
        <div class="input-panel">
            <div class="scene-group"><h3>Adegan 1: Hook (3 detik)</h3><div class="media-buttons"><label for="hook-media-input" class="file-label" id="hook-media-label">Pilih Video/GIF</label><input type="file" id="hook-media-input" accept="video/*,image/gif"><label for="hook-image-input" class="file-label" id="hook-image-label">Pilih Gambar</label><input type="file" id="hook-image-input" accept="image/jpeg,image/png"></div><label for="hook-text">Teks Hook:</label><input type="text" id="hook-text" placeholder="Contoh: Botol minum gampang bocor?"></div>
            <div class="scene-group"><h3>Adegan 2: Produk (5 detik)</h3><div class="media-buttons"><label for="product-media-input" class="file-label" id="product-media-label">Pilih Video/GIF</label><input type="file" id="product-media-input" accept="video/*,image/gif"><label for="product-image-input" class="file-label" id="product-image-label">Pilih Gambar</label><input type="file" id="product-image-input" accept="image/jpeg,image/png"></div><label for="product-text">Teks Solusi:</label><input type="text" id="product-text" placeholder="Contoh: Pakai botol anti tumpah ini!"></div>
            <div class="scene-group"><h3>Adegan 3: CTA (3 detik)</h3><div class="media-buttons"><label for="cta-media-input" class="file-label" id="cta-media-label">Pilih Video/GIF</label><input type="file" id="cta-media-input" accept="video/*,image/gif"><label for="cta-image-input" class="file-label" id="cta-image-label">Pilih Gambar</label><input type="file" id="cta-image-input" accept="image/jpeg,image/png"></div><label for="cta-text">Teks Call to Action:</label><input type="text" id="cta-text" placeholder="Contoh: Cek Keranjang Kuning!"></div>
            <div class="input-group"><label for="music-select">Musik Latar (Bebas Copyright)</label><select id="music-select"><option value="https://cdn.pixabay.com/download/audio/2022/08/04/audio_2d02518e0a.mp3">Upbeat & Happy</option><option value="https://cdn.pixabay.com/download/audio/2022/11/21/audio_a1bf8935a8.mp3">Chill Lofi</option><option value="https://cdn.pixabay.com/download/audio/2022/05/27/audio_1808f27883.mp3">Modern & Cool</option></select></div>
            <button id="generate-button">ðŸš€ Generate & Export Video</button>
        </div>
        <div class="preview-panel"><h2>Preview & Hasil</h2><p>Video hasil generate akan muncul di sini.</p><video id="output-video" controls></video></div>
    </div>

    <script>
        const { createFFmpeg, fetchFile } = FFmpeg;
        
        const progressOverlay = document.getElementById('progress-overlay');
        const progressText = document.getElementById('progress-text');
        const loadingSpinner = document.getElementById('loading-spinner');
        const progressBarContainer = document.getElementById('progress-bar-container');
        const progressBarFill = document.getElementById('progress-bar-fill');
        const progressPercentage = document.getElementById('progress-percentage');

        const ffmpeg = createFFmpeg({
    log: true,
    progress: (p) => { /* ... */ },
    corePath: "https://unpkg.com/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js", // <-- INI YANG BENAR
});

        // (Salin semua kode dari v2.0 untuk `scenes` dan `setupEventListeners`)
        const scenes = [ { id: 'hook', duration: 3, mediaFile: null, isImage: false, labelElement: [document.getElementById('hook-media-label'), document.getElementById('hook-image-label')] }, { id: 'product', duration: 5, mediaFile: null, isImage: false, labelElement: [document.getElementById('product-media-label'), document.getElementById('product-image-label')] }, { id: 'cta', duration: 3, mediaFile: null, isImage: false, labelElement: [document.getElementById('cta-media-label'), document.getElementById('cta-image-label')] } ];
        function setupEventListeners() { scenes.forEach((scene, index) => { const mediaInput = document.getElementById(`${scene.id}-media-input`); const imageInput = document.getElementById(`${scene.id}-image-input`); const handleFileSelect = (e, isImage) => { const file = e.target.files[0]; scenes[index].mediaFile = file; scenes[index].isImage = isImage; scene.labelElement.forEach(label => label.classList.remove('uploaded')); const selectedLabel = isImage ? scene.labelElement[1] : scene.labelElement[0]; selectedLabel.classList.add('uploaded'); selectedLabel.textContent = file.name; }; mediaInput.addEventListener('change', (e) => handleFileSelect(e, false)); imageInput.addEventListener('change', (e) => handleFileSelect(e, true)); }); document.getElementById('generate-button').addEventListener('click', generateVideo); }
        
        async function generateVideo() {
            if (scenes.some(scene => !scene.mediaFile)) {
                alert("Harap lengkapi media untuk semua adegan!");
                return;
            }

            // Tampilkan overlay
            progressOverlay.style.display = 'flex';
            
            // --- Logika Loading & Rendering BARU ---
            
            // Tahap 1: Loading
            if (!ffmpeg.isLoaded()) {
                loadingSpinner.style.display = 'block';
                progressBarContainer.style.display = 'none';
                progressPercentage.style.display = 'none';
                progressText.textContent = "Memuat Mesin Render...";
                
                await ffmpeg.load();
            }

            // Tahap 2: Persiapan File
            loadingSpinner.style.display = 'block'; // Tetap tampilkan spinner saat persiapan
            progressBarContainer.style.display = 'none';
            progressPercentage.style.display = 'none';
            progressText.textContent = "Mempersiapkan File...";
            
            for (const scene of scenes) {
                ffmpeg.FS('writeFile', scene.mediaFile.name, await fetchFile(scene.mediaFile));
            }
            const musicURL = document.getElementById('music-select').value;
            ffmpeg.FS('writeFile', 'music.mp3', await fetchFile(musicURL));

            // Tahap 3: Rendering (Sekarang tampilkan progress bar asli)
            loadingSpinner.style.display = 'none';
            progressBarContainer.style.display = 'block';
            progressPercentage.style.display = 'block';
            progressBarFill.style.width = '0%';
            progressPercentage.textContent = '0%';
            progressText.textContent = "Memproses Video...";

            // (Salin semua kode `command` dan `ffmpeg.run` dari v2.0)
            const protect = (str) => str.replace(/[:'[```]/g, '\\$&'); const texts = { hook: protect(document.getElementById('hook-text').value), product: protect(document.getElementById('product-text').value), cta: protect(document.getElementById('cta-text').value), }; const command = []; const filterComplex = []; const concatInputs = []; scenes.forEach((scene, i) => { if (scene.isImage) { command.push('-loop', '1'); command.push('-t', scene.duration.toString()); } command.push('-i', scene.mediaFile.name); let inputChain = `[${i}:v]`; if (scene.isImage) { filterComplex.push(`${inputChain}zoompan=z='min(zoom+0.0015,1.5)':d=${scene.duration*25}:x='iw/2-(iw/zoom/2)':y='ih/2-(ih/zoom/2)':s=720x1280,setsar=1[v${i}_pre]`); inputChain = `[v${i}_pre]`; } else { filterComplex.push(`${inputChain}scale=720:1280,setsar=1[v${i}_pre]`); inputChain = `[v${i}_pre]`; } const text = texts[scene.id]; const fontSize = scene.id === 'cta' ? 70 : 60; const fontColor = scene.id === 'product' ? 'yellow' : 'white'; const boxColor = scene.id === 'cta' ? 'red@0.8' : 'black@0.5'; const yPos = scene.id === 'product' ? 'h*0.3' : 'h*0.7'; filterComplex.push(`${inputChain}drawtext=text='${text}':fontsize=${fontSize}:fontcolor=${fontColor}:x=(w-text_w)/2:y=${yPos}:box=1:boxcolor=${boxColor}:boxborderw=10[v${i}_final]`); concatInputs.push(`[v${i}_final]`); }); command.push('-i', 'music.mp3'); const audioInputIndex = scenes.length; filterComplex.push(`${concatInputs.join('')}concat=n=${scenes.length}:v=1:a=0[v_out]`); filterComplex.push(`[${audioInputIndex}:a]volume=0.4[a_out]`); command.push('-filter_complex', filterComplex.join(';')); command.push('-map', '[v_out]', '-map', '[a_out]'); command.push('-c:v', 'libx264', '-preset', 'ultrafast', '-c:a', 'aac', '-pix_fmt', 'yuv420p', 'output.mp4');

            await ffmpeg.run(...command);
            
            // Tahap 4: Selesai
            progressText.textContent = "Selesai! Menyiapkan Hasil...";
            const data = ffmpeg.FS('readFile', 'output.mp4');
            const videoUrl = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));

            document.getElementById('output-video').src = videoUrl;
            progressOverlay.style.display = 'none';

            const a = document.createElement('a'); a.href = videoUrl; a.download = 'video_universal_result.mp4'; document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }

        setupEventListeners();
    </script>
</body>
</html>